name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up CMake
      uses: lukka/get-cmake@latest

    - name: Set up Ninja
      uses: lukka/get-ninja@latest

    - name: Configure and build Chapter 1
      run: |
        cd chapters/chapter01/code
        mkdir build
        cd build
        cmake .. -G Ninja
        ninja

    - name: Configure and build Chapter 2 examples
      run: |
        cd chapters/chapter02/code
        Get-ChildItem -Directory | ForEach-Object {
          if (Test-Path "$($_.FullName)/CMakeLists.txt") {
            mkdir "$($_.FullName)/build" -Force
            cd "$($_.FullName)/build"
            cmake .. -G Ninja
            ninja
            cd ../../..
          }
        }

  build-ubuntu:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential

    - name: Configure and build Chapter 1
      run: |
        cd chapters/chapter01/code
        mkdir build
        cd build
        cmake .. -G Ninja
        ninja

    - name: Configure and build Chapter 2 examples
      run: |
        cd chapters/chapter02/code
        for dir in */; do
          if [ -f "$dir/CMakeLists.txt" ]; then
            mkdir -p "$dir/build"
            cd "$dir/build"
            cmake .. -G Ninja
            ninja
            cd ../..
          fi
        done

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake ninja

    - name: Configure and build Chapter 1
      run: |
        cd chapters/chapter01/code
        mkdir build
        cd build
        cmake .. -G Ninja
        ninja

    - name: Configure and build Chapter 2 examples
      run: |
        cd chapters/chapter02/code
        for dir in */; do
          if [ -f "$dir/CMakeLists.txt" ]; then
            mkdir -p "$dir/build"
            cd "$dir/build"
            cmake .. -G Ninja
            ninja
            cd ../..
          fi
        done

  latex-build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-fonts-extra texlive-lang-chinese python3-pygments latexmk

    - name: Build LaTeX documents
      run: |
        cd chapters
        for chapter in chapter*/; do
          if [ -f "$chapter/${chapter%/}.tex" ]; then
            cd "$chapter"
            latexmk -pdf "${chapter%/}.tex" || echo "Failed to build $chapter"
            cd ..
          fi
        done

    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: latex-pdfs
        path: chapters/chapter*/chapter*.pdf
